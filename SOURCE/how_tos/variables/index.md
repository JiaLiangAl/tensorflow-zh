# 变量: 创建、 初始化、 保存和恢复 <a class="md-anchor" id="AUTOGENERATED-variables--creation--initialization--saving--and-loading"></a>

当你训练一个模型, 你用 [variables](../../api_docs/python/state_ops.md) 保持和更新参数。变量是内存中容纳张量的。它们必须被显示的初始化且在训练中和训练后能保存到磁盘。你后续可以恢复保存的值来练习或分析这个模型。此文档涉及以下TensorFlow类，请随它们参考手册的链接，以获得对它们API完整的描述：


*   [`tf.Variable`](../../api_docs/python/state_ops.md#Variable) 类.
*   [`tf.train.Saver`](../../api_docs/python/state_ops.md#Saver) 类.


## 创建 <a class="md-anchor" id="AUTOGENERATED-creation"></a>

当你创建一个 [Variable](../../api_docs/python/state_ops.md) 你传入
`Tensor` 作为它的初始值到 `Variable()` 构造器. TensorFlow 提供来自 [constants or random values](../../api_docs/python/constant_op.md)的生成常用于初始化的张量的ops集合。

请注意所有的这些ops要求你指定张量的形状。那个形状会自动的变成变量的形状。变量通常有一个固定的形状，但是TensorFlow 提供先进的机制去改变变量的形状。

```python
# Create two variables.
weights = tf.Variable(tf.random_normal([784, 200], stddev=0.35),
                      name="weights")
biases = tf.Variable(tf.zeros([200]), name="biases")
```

调用 `tf.Variable()` 添加若干操作到图：

*  一个持有变量值的 `variable` 操作 .
*  一个设置变量到其初始值的初始化操作。这实际上是一个  `tf.assign` 操作.
*  初始化的操作，如示例中 `biases` 变量的 `zeros` 操作也被添加到图中

The value returned by `tf.Variable()`返回的值是Python类`tf.Variable`的一个实例。

## 初始化 <a class="md-anchor" id="AUTOGENERATED-initialization"></a>

变量的初始化器必须在你的模型中其他操作执行前显式的被执行。简单的做法就是添加一个执行所有变量初始化器的操作，在使用模型之前执行这个操作。

你可以选择性的从一个断点文件中恢复变量的值，见如下。

用`tf.initialize_all_variables()` 添加一个执行变量初始化的操作。只在你完整地构建完你的模型且在sesson中启动它之后执行这个操作。

```python
# Create two variables.
weights = tf.Variable(tf.random_normal([784, 200], stddev=0.35),
                      name="weights")
biases = tf.Variable(tf.zeros([200]), name="biases")
...
# Add an op to initialize the variables.
init_op = tf.initialize_all_variables()

# Later, when launching the model
with tf.Session() as sess:
  # Run the init operation.
  sess.run(init_op)
  ...
  # Use the model
  ...
```

### 从其它变量初始化 <a class="md-anchor" id="AUTOGENERATED-initialization-from-another-variable"></a>

你有时需要用其他变量来初始化一个变量的值。当一个操作需要被 `tf.initialize_all_variables()` 初始化器并行地添加所有变量时，您必须注意。

其他变量通过`initialized_value()` 属性用其值初始化一个新的变量。你可以直接用初始化值作为新变量的初始值，也可以用它作为任何其他张量来计算新变量的值


```python
# Create a variable with a random value.
weights = tf.Variable(tf.random_normal([784, 200], stddev=0.35),
                      name="weights")
# Create another variable with the same value as 'weights'.
w2 = tf.Variable(weights.initialized_value(), name="w2")
# Create another variable with twice the value of 'weights'
w_twice = tf.Variable(weights.initialized_value() * 0.2, name="w_twice")
```

### 自定义初始化 <a class="md-anchor" id="AUTOGENERATED-custom-initialization"></a>

这个便利的方法 `tf.initialize_all_variables()` 添加一个操作初始化模型里的 *所有变量*。你也可以显式的传入变量列表来初始化。参照[Variables Documentation](../../api_docs/python/state_ops.md) 以获得更多选项，包括检查变量是否被初始化。


## 保存和恢复 <a class="md-anchor" id="AUTOGENERATED-saving-and-restoring"></a>

保存和恢复一个模型的最简单的方式是用一个 `tf.train.Saver` 对象。

构造器为图中所有或者特定的列表的变量添加 `save` 和 `restore` 操作到图。保存者对象提供方法执行这些操作，为检测点文件指定路径去写入或读取。

### 检测点文件 <a class="md-anchor" id="AUTOGENERATED-checkpoint-files"></a>

变量保存在二进制文件中，这些文件大致包含从变量名到张量值的映射。

一旦你创建一个 `Saver` 对象，你可以随意地为在检测点文件中的变量选择名称。默认的，它使用每个变量的[`Variable.name`](../../api_docs/python/state_ops.md#Variable.name)属性的值。

### 保存变量 <a class="md-anchor" id="AUTOGENERATED-saving-variables"></a>

用 `tf.train.Saver()` 创建一个 `Saver` 去管理所有在模型中的变量；

```python
# Create some variables.
v1 = tf.Variable(..., name="v1")
v2 = tf.Variable(..., name="v2")
...
# Add an op to initialize the variables.
init_op = tf.initialize_all_variables()

# Add ops to save and restore all the variables.
saver = tf.train.Saver()

# Later, launch the model, initialize the variables, do some work, save the
# variables to disk.
with tf.Session() as sess:
  sess.run(init_op)
  # Do some work with the model.
  ..
  # Save the variables to disk.
  save_path = saver.save(sess, "/tmp/model.ckpt")
  print "Model saved in file: ", save_path
```

### 恢复变量 <a class="md-anchor" id="AUTOGENERATED-restoring-variables"></a>

同样的 `Saver` 用来恢复变量。注意的是，当你从一个文件恢复变量时，你不必提前初始化它们。

```python
# Create some variables.
v1 = tf.Variable(..., name="v1")
v2 = tf.Variable(..., name="v2")
...
# Add ops to save and restore all the variables.
saver = tf.train.Saver()

# Later, launch the model, use the saver to restore variables from disk, and
# do some work with the model.
with tf.Session() as sess:
  # Restore variables from disk.
  saver.restore(sess, "/tmp/model.ckpt")
  print "Model restored."
  # Do some work with the model
  ...
```

### 选择保存和恢复的变量 <a class="md-anchor" id="AUTOGENERATED-choosing-which-variables-to-save-and-restore"></a>

如果你不传入任何参数到 `tf.train.Saver()` ，saver 操纵所有在图中的变量。它们全部都会按创建时传入的名称被保存。

有时候显式地为检测点文件中的变量指定名称很有用的。例如，你可能训练了一个拥有变量名为`"weights"`的变量的模型，你想把这个变量恢复到一个变量名为`"params"`的变量中。

有时候只保存或恢复一个模型用到的变量的一个子集也是很有用的。例如，你可能训练了一个5层的神经网络，你现在想训练一个新的6层的模型，从之前训练好的5层网络模型中恢复参数到新模型的前5层。

你可以轻松地通过向`tf.train.Saver()` 构造器传入一个Python字典（键是要用的名称，值是需要处理的变量）来指定要保存的名称和变量。

注意:

*  你想创建多少 saver 对象就创建多少，如果你需要保存和恢复模型中变量的不同子集。同样的变量可以在多个 saver 对象中出现，它的值只会在 saver 的 `restore()` 方法执行时改变。

* 如果你在启动一个 session 时，只恢复了模型中变量的一个子集，你必须为其他变量执行一个初始化操作。参照
[`tf.initialize_variables()`](../../api_docs/python/state_ops.md#initialize_variables)
获得更多信息。

```python
# Create some variables.
v1 = tf.Variable(..., name="v1")
v2 = tf.Variable(..., name="v2")
...
# Add ops to save and restore only 'v2' using the name "my_v2"
saver = tf.train.Saver({"my_v2": v2})
# Use the saver object normally after that.
...
```
